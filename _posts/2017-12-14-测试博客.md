---
title: æµ‹è¯•åšå®¢
tags: test
description: è¿™æ˜¯ä¸€é¦–ç®€å•çš„å°æƒ…æ­Œ
categories:
- tml
---
## MVVMé£æµå²
---
-  å‡ºç”Ÿæ—¶é—´ä¸è¯¦ï¼ŒAndroid Studio 1.3æ—¶éœ€è¦é€šè¿‡ä¾èµ–åº“æ·»åŠ `com.android.databinding `
- äºAndroid Studio 2.0è¢«å†…ç½®ï¼Œç›´æ¥é…ç½®

{% highlight java %}
android {
    ....
    dataBinding {
        enabled = true
    }
}
 {% endhighlight %}
- äºAndroid Studio2.1 Preview 3å¼€å§‹æ”¯æŒåŒå‘ç»‘å®šï¼Œä»æ­¤äººç”Ÿèµ°å…¥æ­£è½¨
- äº2017å¹´ä¸‹åŠå¹´ ä¼´éšç€ [Android Architecture Components](https://developer.android.google.cn/topic/libraries/architecture/index.html) 1.0 stableå‘å¸ƒï¼Œäººç”Ÿä»æ­¤è¿›å…¥äº†å·…å³°
>PS: MVVM æ˜¯ä¸€ç§æ€æƒ³ï¼Œæ•°æ®çš„åŒå‘ç»‘å®š,å¹¶ä¸æ˜¯Androidç‰¹æœ‰çš„ï¼Œå…¶ä»–çš„æ¯”å¦‚AngularJSå’ŒIOSçš„MVVM
æœ€åˆæˆ‘è¿˜ä»¥ä¸ºæ˜¯æˆ‘ä»¬å¤§Googleçš„ä¸“åˆ©[å°´å°¬è„¸]ğŸ˜Œ

## ä¸€ä¸ªä¼˜ç§€çš„ç”·äººéœ€è¦çš„æ°”è´¨
---
###  æ•°æ®é©±åŠ¨
åœ¨æˆ‘ä»¬å¹³å¸¸çš„å¼€å‘ï¼Œå½“æ•°æ®å˜åŒ–éœ€è¦æ›´æ–°UIçš„æ—¶å€™ï¼Œéœ€è¦å…ˆè·å–UIæ§ä»¶çš„å¼•ç”¨ï¼ˆfindViewByIdï¼‰,ç„¶åå»æ›´æ–°UIï¼Œè·å–æ§ä»¶çš„å±æ€§ä¹Ÿæ˜¯éœ€è¦é€šè¿‡UIæ§ä»¶çš„å¼•ç”¨ã€‚åœ¨MVVMä¸­ï¼Œè¿™äº›éƒ½æ˜¯é€šè¿‡æ•°æ®é©±åŠ¨æ¥è‡ªåŠ¨å®Œæˆçš„ï¼Œæ•°æ®å˜åŒ–åä¼šè‡ªåŠ¨æ›´æ–°UIï¼ŒUIçš„æ”¹å˜ä¹Ÿèƒ½è‡ªåŠ¨åé¦ˆåˆ°æ•°æ®å±‚ï¼Œæ•°æ®æˆä¸ºä¸»å¯¼å› ç´ ã€‚è¿™æ ·MVVMå±‚åœ¨ä¸šåŠ¡é€»è¾‘å¤„ç†ä¸­åªè¦å…³å¿ƒæ•°æ®ï¼Œä¸éœ€è¦ç›´æ¥å’ŒUIæ‰“äº¤é“ï¼Œåœ¨ä¸šåŠ¡å¤„ç†è¿‡ç¨‹ä¸­ç®€å•æ–¹ä¾¿å¾ˆå¤šã€‚
###  ä½è€¦åˆåº¦
MVVMæ¨¡å¼ä¸­ï¼Œæ•°æ®æ˜¯ç‹¬ç«‹äºUIçš„ã€‚

æ•°æ®å’Œä¸šåŠ¡é€»è¾‘å¤„äºä¸€ä¸ªç‹¬ç«‹çš„ViewModelä¸­ï¼ŒViewModelåªéœ€è¦å…³æ³¨æ•°æ®å’Œä¸šåŠ¡é€»è¾‘ï¼Œä¸éœ€è¦å’ŒUIæˆ–è€…æ§ä»¶æ‰“äº¤é“ã€‚UIæƒ³æ€ä¹ˆå¤„ç†æ•°æ®éƒ½ç”±UIè‡ªå·±å†³å®šï¼ŒViewModelä¸æ¶‰åŠä»»ä½•å’ŒUIç›¸å…³çš„äº‹ï¼Œä¹Ÿä¸æŒæœ‰UIæ§ä»¶çš„å¼•ç”¨ã€‚å³ä¾¿æ˜¯æ§ä»¶æ”¹å˜äº†ï¼ˆæ¯”å¦‚ï¼šTextViewæ¢æˆEditTextï¼‰ï¼ŒViewModelä¹Ÿå‡ ä¹ä¸éœ€è¦æ›´æ”¹ä»»ä½•ä»£ç ã€‚å®ƒéå¸¸å®Œç¾çš„è§£è€¦äº†Viewå±‚å’ŒViewModel
### æ›´æ–°UI
åœ¨MVVMä¸­ï¼Œæ•°æ®å‘ç”Ÿå˜åŒ–åï¼Œæˆ‘ä»¬åœ¨å·¥ä½œçº¿ç¨‹ç›´æ¥ä¿®æ”¹ï¼ˆåœ¨æ•°æ®æ˜¯çº¿ç¨‹å®‰å…¨çš„æƒ…å†µä¸‹ï¼‰ViewModelçš„æ•°æ®å³å¯ï¼Œä¸ç”¨å†è€ƒè™‘è¦åˆ‡åˆ°ä¸»çº¿ç¨‹æ›´æ–°UIäº†ï¼Œè¿™äº›äº‹æƒ…ç›¸å…³æ¡†æ¶éƒ½å¸®æˆ‘ä»¬åšäº†ã€‚
### å¯å¤ç”¨æ€§
ä¸€ä¸ªViewModelå¯ä»¥å¤ç”¨åˆ°å¤šä¸ªViewä¸­ã€‚åŒæ ·çš„ä¸€ä»½æ•°æ®ï¼Œå¯ä»¥æä¾›ç»™ä¸åŒçš„UIå»åšå±•ç¤ºã€‚å¯¹äºç‰ˆæœ¬è¿­ä»£ä¸­é¢‘ç¹çš„UIæ”¹åŠ¨ï¼Œæ›´æ–°æˆ–æ–°å¢ä¸€å¥—Viewå³å¯ã€‚å¦‚æœæƒ³åœ¨UIä¸ŠåšA/B Testingï¼Œé‚£MVVMæ˜¯ä½ ä¸äºŒé€‰æ‹©ã€‚
>PS: æœ¬éƒ¨åˆ†ä¼˜åŠ¿å‚è€ƒ[è¿™ç¯‡æ–‡ç« ](https://tech.meituan.com/android_mvvm.html)

## å¦‚ä½•æˆä¸ºä¸€ä¸ªä¼˜ç§€çš„ç”·äºº
---
###  å¦‚ä½•æŠŠæ•°æ®å’ŒViewè¿›è¡Œç»‘å®š
æŠŠå¤§è±¡è£…å…¥ç®±å­éœ€è¦ä¸‰éƒ¨

1. æ·»åŠ ä¸€ä¸ªPOJOç±»

{% highlight java %}
    public class User {
        private final String firstName;
        private final String lastName;
        private String displayName;
        private int age;
     
        public User(String firstName, String lastName) {
            this.firstName = firstName;
            this.lastName = lastName;
        }
     
        public User(String firstName, String lastName, int age) {
            this(firstName, lastName);
            this.age = age;
        }
     
        public int getAge() {
            return age;
        }
     
        public String getFirstName() {
            return firstName;
        }
     
        public String getLastName() {
            return lastName;
        }
    }
{% endhighlight %}

  2.  å®šä¹‰ä¸ä½¿ç”¨Variable
  
```android
<?xml version="1.0" encoding="utf-8"?>
<layout xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:app="http://schemas.android.com/apk/res-auto"
    xmlns:tools="http://schemas.android.com/tools">
<data>
    <import type="android.graphics.drawable.Drawable"/>
    <variable name="user"  type="com.example.User"/>
    <variable name="image" type="Drawable"/>
    <variable name="note"  type="String"/>
<variable
    name="viewModel"
    type="com.demo.tangminglong.mvvmprojecttest.viewmodel.MainViewModel"/>
 </data>
    ...
<Button
            android:padding="10dp"
            android:layout_gravity="center_horizontal"
            android:gravity="center"
            android:layout_width="200dp"
            android:layout_height="50dp"
            android:text="@{user.firstName}"
         />
 </layou>

```

ä¸€ä¸ªæ ¹æ®layout.xmlå°†è‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªä»¥Bindingç»“å°¾çš„ç±»æ–‡ä»¶ï¼Œä¾‹å¦‚`main_activity.xml `å°†ç”ŸæˆMainActivityBinding,ç”Ÿæˆçš„ä»£ç ä½ç½®å¦‚ä¸‹å›¾æ‰€ç¤º
![847D2E67-524A-451D-97D6-2CE117B4B674.png](http://upload-images.jianshu.io/upload_images/1263922-61de051a521349e7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

3. ç»‘å®šVariable

Bindingç±»æ ¹æ®layout.xmlå®šä¹‰çš„å˜é‡ï¼ˆvariableï¼‰,å°†ä¼šè‡ªåŠ¨ç”Ÿæˆç›¸åº”çš„setæ–¹æ³•ï¼ŒåŒæ—¶æˆ‘ä»¬é€šå¸¸çš„setContentView(int)ä¹Ÿè¢«æ›¿æ¢ï¼Œå¦‚ä¸‹ä»£ç 

```android
ActivityMainBinding binding = DataBindingUtil.setContentView(this,R.layout.activity_main);
        mainViewModel = new MainViewModel(this,this);
        binding.setViewModel(mainViewModel);
```

### å¦‚ä½•æ›´æ–°æ•°æ®
ä¸€ä¸ªPOJOå€¼æ”¹å˜å¹¶ä¸èƒ½å¤Ÿè‡ªåŠ¨æ›´æ–°UIï¼ŒdataBingçš„å¼ºå¤§ä¹‹å¤„åœ¨äºå€¼æ”¹å˜èƒ½å¤Ÿè‡ªåŠ¨åŒæ­¥æ›´æ–°UI(å•å‘ç»‘å®š)ï¼Œå®ç°çš„æ–¹å¼æœ‰å¦‚ä¸‹ä¸‰ç§
  1. **Observable Objects** 
ç”¨ä¸€ä¸ªç±»æ¥å®ç°[Observable](https://developer.android.google.cn/reference/android/databinding/Observable.html)ä¸ºäº†æ–¹ä¾¿ï¼ŒAndroid åŸç”Ÿæä¾›äº†å·²ç»å°è£…å¥½çš„ä¸€ä¸ªç±» - BaseObservableï¼Œå¹¶ä¸”å®ç°äº†ç›‘å¬å™¨çš„æ³¨å†Œæœºåˆ¶ã€‚
æˆ‘ä»¬å¯ä»¥ç›´æ¥ç»§æ‰¿BaseObservable

```android
private static class User extends BaseObservable {
   private String firstName;
   private String lastName;
   @Bindable
   public String getFirstName() {
       return this.firstName;
   }
   @Bindable
   public String getLastName() {
       return this.lastName;
   }
   public void setFirstName(String firstName) {
       this.firstName = firstName;
       notifyPropertyChanged(BR.firstName);
   }
   public void setLastName(String lastName) {
       this.lastName = lastName;
       notifyPropertyChanged(BR.lastName);
   }
}
```

BR æ˜¯ç¼–è¯‘é˜¶æ®µç”Ÿæˆçš„ä¸€ä¸ªç±»ï¼ŒåŠŸèƒ½ä¸ R.java ç±»ä¼¼ï¼Œç”¨ @Bindable æ ‡è®°è¿‡ getter æ–¹æ³•ä¼šåœ¨ BR ä¸­ç”Ÿæˆä¸€ä¸ª entryï¼Œå½“æˆ‘ä»¬

é€šè¿‡ä»£ç å¯ä»¥çœ‹å‡ºï¼Œå½“æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶è¿˜æ˜¯éœ€è¦æ‰‹åŠ¨å‘å‡ºé€šçŸ¥ã€‚ é€šè¿‡è°ƒç”¨notifyPropertyChanged(BR.firstName)æ¥é€šçŸ¥ç³»ç»Ÿ BR.firstName è¿™ä¸ª entry çš„æ•°æ®å·²ç»å‘ç”Ÿå˜åŒ–ï¼Œéœ€è¦æ›´æ–° UIã€‚
  2. **ObservableFields**
 è¿˜æœ‰ä¸€ç§æ›´ç»†ç²’åº¦çš„ç»‘å®šæ–¹å¼ï¼Œå¯ä»¥å…·ä½“åˆ°æˆå‘˜å˜é‡ï¼Œè¿™ç§æ–¹å¼æ— éœ€ç»§æ‰¿ BaseObservableï¼Œä¸€ä¸ªç®€å•çš„ POJO å°±å¯ä»¥å®ç°ã€‚
 
```android
private static class User {
   public final ObservableField<String> firstName =
       new ObservableField<>();
   public final ObservableField<String> lastName =
       new ObservableField<>();
   public final ObservableInt age = new ObservableInt();
}
```

ç³»ç»Ÿä¸ºæˆ‘ä»¬æä¾›äº†æ‰€æœ‰çš„ primitive type æ‰€å¯¹åº”çš„ Observableç±»ï¼Œä¾‹å¦‚ ObservableIntã€ObservableFloatã€ObservableBoolean ç­‰ç­‰ï¼Œè¿˜æœ‰ä¸€ä¸ª ObservableField å¯¹åº”ç€ reference typeã€‚
  3. **Observable Collections**
å¯¹åº”ObservableFieldsçš„é›†åˆï¼Œç”¨æ³•å’ŒObservableFieldså·®ä¸å¤š
>PS: åŒå‘ç»‘å®šè¡¨è¾¾å¼å¯¹åº”`@={setting.cacheEnable}`,å•å‘ç»‘å®šå¯¹åº”`@{setting.cacheEnable}`,å…·ä½“å¯å‚ç…§[GitHubçš„Demo](https://github.com/TMLAndroid/MVVMDemo)
### äº‹ä»¶å¤„ç†ï¼ˆEvent Handlingï¼‰
Data Binding å¯ä»¥é€šè¿‡è¡¨è¾¾å¼å¤„ç†Viewçš„äº‹ä»¶ï¼ˆeg.onClickï¼‰,äº‹ä»¶å¤„ç†æœ‰ä¸¤ç§æ–¹å¼å¤„ç†ï¼Œä¸€ä¸ªæ˜¯**æ–¹æ³•å¼•ç”¨ï¼ˆMethod Referenceï¼‰**,ä¸€ä¸ªæ˜¯**ç›‘å¬ç»‘å®šï¼ˆListener Bingingsï¼‰**
- **æ–¹æ³•å¼•ç”¨ï¼ˆMethod Referenceï¼‰**
æ–¹æ³•å¼•ç”¨çš„æ–¹å¼`android:onClcik`å¯¹åº”æ–¹æ³•Vuew#onClickï¼Œå› ä¸ºå±æ€§æ˜¯åœ¨ç¼–è¯‘æœŸè¿›è¡Œï¼Œæ‰€ä»¥ä¸€æ—¦æœ‰é”™è¯¯ä¼šç«‹å³æŠ¥é”™ï¼Œå¼•ç”¨çš„æ–¹å¼å¦‚ä¸‹

```android
public class MainViewModel {
    private Context context;

    public MainViewModel(Context context) {
        this.context = context;
    }

    public void onClickOne(View view){
        context.startActivity(new Intent(context, SingleMainActivity.class));
    }

    public void onClickTwo(View view){
        context.startActivity(new Intent(context, DoubleMainActivity.class));
    }
}
```


```android
<Button
            android:padding="10dp"
            android:layout_gravity="center_horizontal"
            android:gravity="center"
            android:layout_width="200dp"
            android:layout_height="50dp"
            android:text="@string/singleBundle"
            android:onClick="@{viewModel::onClickOne}"/>
        <Button
            android:padding="10dp"
            android:layout_gravity="center_horizontal"
            android:gravity="center"
            android:layout_width="200dp"
            android:layout_height="50dp"
            android:text="@string/doubleBundle"
            android:onClick="@{viewModel.onClickTwo}"/>
```

è°ƒç”¨æ–¹å¼ä¸º`variable.method`æˆ–è€…`variable::method`
æ³¨æ„ï¼šæ–¹æ³•é‡Œé¢éœ€åˆ°å‚æ•°view
- **ç›‘å¬ç»‘å®šï¼ˆListener Bingingsï¼‰**
Listener Bingingsçš„ä¼˜ç‚¹æ˜¯å¯ä»¥ä½¿ç”¨å¤æ‚çš„å‚æ•°ï¼Œæ¯”å¦‚ä¸‹é¢æ¥å£

```android
public interface ItemEventHandler {
    void clickTitle(View view,Item item);
}
```

å¸ƒå±€æ–‡ä»¶å¦‚ä¸‹

```android
<TextView
    android:id="@+id/textView"
    android:layout_width="0dp"
    android:layout_height="match_parent"
    android:layout_weight="1"
    android:onClick="@{(view)->handler.clickTitle(view,item)}"
    />
```

ä¸¤è€…çš„åŒºåˆ«ä¸»è¦æ˜¯Method Referenceä¼šåœ¨ç»‘å®šæ•°æ®æ—¶åˆ›å»ºå¥½Viewçš„onClickListenerï¼Œè€ŒListener Bindingsåœ¨äº‹ä»¶å‘ç”Ÿæ—¶æ‰ä¼šåˆ›å»ºã€‚
> PS :Method Referenceåœ¨xmlä¸ä¼šè‡ªåŠ¨æç¤º
###  RecyclerView(åˆ—è¡¨)

 ```android
ListItemBinding binding = ListItemBinding.inflate(layoutInflater, viewGroup, false);
//or
ListItemBinding binding = DataBindingUtil.inflate(layoutInflater, R.layout.list_item, viewGroup, false);
  ```

###  è‡ªå®šä¹‰å±æ€§

```android
<de.hdodenhof.circleimageview.CircleImageView
                    android:id="@+id/image_owner"
                    android:layout_width="65dp"
                    android:layout_height="65dp"
                    app:imageUrl="@{viewModel.ownerAvatarUrl}"/>
```

è¿™é‡Œé¢æœ‰è‡ªå®šä¹‰å±æ€§imageUrlï¼Œè¿™å¹¶ä¸æ˜¯å®šä¹‰åœ¨è‡ªå®šä¹‰CircleImageViewé‡Œé¢ï¼Œè€Œæ˜¯é€šè¿‡ä»£ç åŠ¨æ€æ·»åŠ è‡ªå®šä¹‰å±æ€§ï¼Œå…³é”®ä»£ç å¦‚ä¸‹

```android
 @BindingAdapter({"imageUrl"})
    public static void loadImage(ImageView view, String imageUrl) {
        Picasso.with(view.getContext())
                .load(imageUrl)
                .placeholder(R.drawable.placeholder)
                .into(view);
    }
```

å±æ€§imageUrlä¼ å…¥åœ°å€å°±å¯ä»¥å®ç°è‡ªåŠ¨åŠ è½½å›¾ç‰‡åˆ°ImageView
 è‡ªå®šä¹‰å±æ€§Attributeé»˜è®¤æ˜¯æ‰¾setAttributeæ–¹æ³•ï¼Œå¯¹xmlä¼ å…¥çš„å€¼è¿›è¡Œè®¾ç½®ï¼Œeg android:text å¯¹åº” setText(String)ï¼Œä¸å±æ€§ç›¸å…³çš„è¿˜æœ‰`@BindingMethods`å¯ä»¥é‡å‘½å
>PS: æˆ‘ä»¬åœ¨ç¼–å†™xmlæ—¶å€™æœ‰æ—¶å€™è°ƒç”¨importçš„å˜é‡Android Studioä¸èƒ½è‡ªåŠ¨æç¤ºï¼ŒåŸå› æ˜¯å¯¹äºè‡ªå®šä¹‰å±æ€§Android Studioå¯¹å€¼è®¾ç½®ä¸æ”¯æŒè‡ªåŠ¨æç¤ºåŠŸèƒ½
###  å…¶ä»–
å…¶ä»–ä¸€äº›éœ€è¦æ³¨æ„çš„ï¼Œæ¯”å¦‚[è¯­æ³•è¡¨è¾¾](https://developer.android.google.cn/topic/libraries/data-binding/index.html#expression_language)ï¼Œå¸ƒå±€çš„[inclued](https://developer.android.google.cn/topic/libraries/data-binding/index.html#includes)ï¼Œ[ViewStubs](https://developer.android.google.cn/topic/libraries/data-binding/index.html#viewstubs) ä»¥åŠ[converters](https://developer.android.google.cn/topic/libraries/data-binding/index.html#converters)ç­‰æ›´å¤šä½¿ç”¨ï¼Œ[å‚ç…§å®˜æ–¹æ–‡æ¡£](https://developer.android.google.cn/topic/libraries/data-binding/index.html[https://developer.android.google.cn/topic/libraries/data-binding/index.html](https://developer.android.google.cn/topic/libraries/data-binding/index.html)
)
## å¡«å‘
- å¦‚æœå‡ºç°è¿™æ ·çš„é”™è¯¯ä¿¡æ¯`cannot resolve symbol 'ActivityMainBinding'`ä»¥ä¸ºè¿™æ•°æ®ç»‘å®šè‡ªåŠ¨ç”Ÿæˆæ²¡æœ‰åˆ›å»ºæˆåŠŸï¼Œè¯•è¯•ä¸‹é¢å‡ ä¸ªæ–¹æ³•
   1. ç¡®è®¤Moduleæ·»åŠ äº†`dataBinding.enabled = true`
   2. ç¡®è®¤XMLçš„æ ¹å¸ƒå±€æ˜¯`<layout>` 
  3. æ£€æŸ¥layoutçš„åç§°æ˜¯å¦æ­£ç¡®æ‹¼å†™ eg.activity_main.xml å¯¹åº”ActivityMainBinding.java
  4. Run File => Invalidate Caches / Restart to clear the caches. 
  5. Run Project => Clean and Project => Re-Build to regenerate the class file.
  6. é‡å¯Android Studio.
- å¦‚æœå‡ºç°é”™è¯¯ä¿¡æ¯åƒ`**.**.databinding does not exist`å¾ˆå¯èƒ½æ˜¯å› ä¸ºåœ¨æ•°æ®ç»‘å®šåˆ°XMLæ—¶å€™æœ‰é”™è¯¯ï¼Œæ£€æŸ¥é‚£äº›é”™è¯¯ï¼ˆæ¯”å¦‚å¿˜è®°import a java classï¼‰
- `dentifiers must have user defined types from the XML file. View is missing it`è¿™é€šå¸¸æ˜¯å› ä¸ºä½ å¿˜è®°import statementæˆ–è€…å˜é‡æ‹¼å†™é”™è¯¯

## ç‰¹æ®Šé€šé“ğŸ‘‰
å¦‚æœæƒ³*æ·±å…¥äº†è§£*ï¼Œå¯ä»¥å‚çœ‹æˆ‘çš„GitHub [MVVMDemo](https://github.com/TMLAndroid/MVVMDemo)
## å‚è€ƒ
http://xuyushi.github.io/2016/03/05/Android%20MVVM/

https://tech.meituan.com/android_mvvm.html

https://guides.codepath.com/android/Applying-Data-Binding-for-Views

https://developer.android.google.cn/topic/libraries/data-binding/index.html

http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2015/0603/2992.html